



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>COCO - sotabencheval Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#00bcd4">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="cyan" data-md-color-accent="cyan">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#coco" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="sotabencheval Docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              sotabencheval Docs
            </span>
            <span class="md-header-nav__topic">
              
                COCO
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="sotabencheval Docs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    sotabencheval Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Welcome to sotabencheval!" class="md-nav__link">
      Welcome to sotabencheval!
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        COCO
      </label>
    
    <a href="./" title="COCO" class="md-nav__link md-nav__link--active">
      COCO
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="Getting Started" class="md-nav__link">
    Getting Started
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-data-location" title="Server Data Location" class="md-nav__link">
    Server Data Location
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-do-i-initialize-an-evaluator" title="How Do I Initialize an Evaluator?" class="md-nav__link">
    How Do I Initialize an Evaluator?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-do-i-evaluate-predictions" title="How Do I Evaluate Predictions?" class="md-nav__link">
    How Do I Evaluate Predictions?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-do-i-cache-evaluation" title="How Do I Cache Evaluation?" class="md-nav__link">
    How Do I Cache Evaluation?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-full-sotabenchpy-example" title="A Full sotabench.py Example" class="md-nav__link">
    A Full sotabench.py Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#need-more-help" title="Need More Help?" class="md-nav__link">
    Need More Help?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../imagenet/" title="ImageNet" class="md-nav__link">
      ImageNet
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../pascalvoc/" title="PASCAL VOC 2012" class="md-nav__link">
      PASCAL VOC 2012
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="Getting Started" class="md-nav__link">
    Getting Started
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-data-location" title="Server Data Location" class="md-nav__link">
    Server Data Location
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-do-i-initialize-an-evaluator" title="How Do I Initialize an Evaluator?" class="md-nav__link">
    How Do I Initialize an Evaluator?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-do-i-evaluate-predictions" title="How Do I Evaluate Predictions?" class="md-nav__link">
    How Do I Evaluate Predictions?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-do-i-cache-evaluation" title="How Do I Cache Evaluation?" class="md-nav__link">
    How Do I Cache Evaluation?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-full-sotabenchpy-example" title="A Full sotabench.py Example" class="md-nav__link">
    A Full sotabench.py Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#need-more-help" title="Need More Help?" class="md-nav__link">
    Need More Help?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="coco">COCO</h1>
<p><img alt="COCO Dataset Examples" src="../img/coco.jpg" /></p>
<p>You can view the COCO minival leaderboard <a href="https://sotabench.com/benchmarks/object-detection-on-coco-minival">here</a>.</p>
<h2 id="getting-started">Getting Started</h2>
<p>You'll need the following in the root of your repository:</p>
<ul>
<li><code>sotabench.py</code> file - contains benchmarking logic; the server will run this on each commit</li>
<li><code>requirements.txt</code> file - Python dependencies to be installed before running <code>sotabench.py</code></li>
<li><code>sotabench_setup.sh</code> <em>(optional)</em> - any advanced dependencies or setup, e.g. compilation</li>
</ul>
<p>You can write whatever you want in your <code>sotabench.py</code> file to get model predictions on the COCO dataset. For example,
PyTorch users might use torchvision to load the dataset.</p>
<p>But you will need to record your results for the server, and you'll want to avoid doing things like
downloading the dataset on the server. So you should:</p>
<ul>
<li><strong>Point to the server COCO data paths</strong> - popular datasets are pre-downloaded on the server.</li>
<li><strong>Include an Evaluation object</strong> in <code>sotabench.py</code> file to record the results.</li>
<li><strong>Use Caching</strong> <em>(optional)</em> - to speed up evaluation by hashing the first batch of predictions.</li>
</ul>
<p>We explain how to do these various steps below.</p>
<h2 id="server-data-location">Server Data Location</h2>
<p>The COCO validation data is located in the root of your repository on the server at <code>.data/vision/coco</code>. In this folder is contained:</p>
<ul>
<li><code>annotations_trainval2017.zip</code> - containing annotations for the validation images</li>
<li><code>val2017.zip</code> - containing the validation images</li>
</ul>
<p>Your local COCO files may have a different file directory structure, so you
can use control flow like below to change the data path if the script is being
run on sotabench servers:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">sotabencheval.utils</span> <span class="kn">import</span> <span class="n">is_server</span>

<span class="k">if</span> <span class="n">is_server</span><span class="p">():</span>
    <span class="n">DATA_ROOT</span> <span class="o">=</span> <span class="s1">&#39;./.data/vision/coco&#39;</span>
<span class="k">else</span><span class="p">:</span> <span class="c1"># local settings</span>
    <span class="n">DATA_ROOT</span> <span class="o">=</span> <span class="s1">&#39;/home/ubuntu/my_data/&#39;</span>
</pre></div>


<p>This will detect if <code>sotabench.py</code> is being run on the server and change behaviour accordingly.</p>
<h2 id="how-do-i-initialize-an-evaluator">How Do I Initialize an Evaluator?</h2>
<p>Add this to your code - before you start batching over the dataset and making predictions:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">sotabencheval.object_detection</span> <span class="kn">import</span> <span class="n">COCOEvaluator</span>

<span class="n">evaluator</span> <span class="o">=</span> <span class="n">COCOEvaluator</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;My Super Model&#39;</span><span class="p">)</span>
</pre></div>


<p>If you are reproducing a model from a paper, then you can enter the arXiv ID. If you
put in the same model name string as on the <a href="https://sotabench.com/benchmarks/object-detection-on-coco-minival">leaderboard</a>
then you will enable direct comparison with the paper's model. For example:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">sotabencheval.object_detection</span> <span class="kn">import</span> <span class="n">COCOEvaluator</span>

<span class="n">evaluator</span> <span class="o">=</span> <span class="n">COCOEvaluator</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;Mask R-CNN&#39;</span><span class="p">,</span> <span class="n">paper_arxiv_id</span><span class="o">=</span><span class="s1">&#39;1703.06870&#39;</span><span class="p">)</span>
</pre></div>


<p>The above will directly compare with the result of the paper when run on the server.</p>
<h2 id="how-do-i-evaluate-predictions">How Do I Evaluate Predictions?</h2>
<p>The evaluator object has an <a href="https://github.com/paperswithcode/sotabench-eval/blob/a788d17252913e5f2d24733845de80aec23101fb/sotabencheval/object_detection/coco.py#L187">.add()</a> method to submit predictions by batch or in full.</p>
<p>For COCO the expected input is a list of dictionaries, where each dictionary contains detection information
that will be used by the <a href="https://github.com/paperswithcode/sotabench-eval/blob/a788d17252913e5f2d24733845de80aec23101fb/sotabencheval/object_detection/coco_eval.py#L236">loadRes</a> method based on the <a href="https://github.com/cocodataset/cocoapi/tree/master/PythonAPI/pycocotools">pycocotools</a> API. </p>
<p>Each detection can take a dictionary
like the following:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="s1">&#39;image_id&#39;</span><span class="p">:</span> <span class="mi">397133</span><span class="p">,</span> <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">386.1628112792969</span><span class="p">,</span> <span class="mf">69.48855590820312</span><span class="p">,</span> <span class="mf">110.14895629882812</span><span class="p">,</span> <span class="mf">278.2847595214844</span><span class="p">],</span>
<span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.999152421951294</span><span class="p">,</span> <span class="s1">&#39;category_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>


<p>For this benchmark, only bounding box detection ('bbox') is performed at present.</p>
<p>You can do this all at once in a single call to <code>add()</code>, but more naturally, you will 
probably loop over the dataset and call the method for the outputs of each batch.
That would look something like this (for a PyTorch example):</p>
<div class="codehilite"><pre><span></span><span class="o">...</span>

<span class="n">evaluator</span> <span class="o">=</span> <span class="n">COCOEvaluator</span><span class="p">(</span>
                 <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;Mask R-CNN&#39;</span><span class="p">,</span>
                 <span class="n">paper_arxiv_id</span><span class="o">=</span><span class="s1">&#39;1703.06870&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="c1"># potentially formatting of the output here to be a list of dicts</span>
        <span class="n">evaluator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>


<p>When you are done, you can get the results locally by running:</p>
<div class="codehilite"><pre><span></span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
</pre></div>


<p>But for the server you want to save the results by running:</p>
<div class="codehilite"><pre><span></span><span class="n">evaluator</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>This method serialises the results and model metadata and stores to the server database.</p>
<h2 id="how-do-i-cache-evaluation">How Do I Cache Evaluation?</h2>
<p>Sotabench reruns your script on every commit. This is good because it acts like 
continuous integration in checking for bugs and changes, but can be annoying
if the model hasn't changed and evaluation is lengthy. </p>
<p>Fortunately sotabencheval has caching logic that you can use.</p>
<p>The idea is that after the first batch, we hash the model outputs and the
current metrics and this tells us if the model is the same given the dataset.
You can include hashing within an evaluation loop like follows (in the following
example for a PyTorch repository):</p>
<div class="codehilite"><pre><span></span><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="c1"># potentially formatting of the output here to be a list of dicts</span>
        <span class="n">evaluator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">cache_exists</span><span class="p">:</span>
            <span class="k">break</span>

<span class="n">evaluator</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>If the hash is the same as in the server, we infer that the model hasn't changed, so
we simply return hashed results rather than running the whole evaluation again.</p>
<p>Caching is very useful if you have large models, or a repository that is evaluating
multiple models, as it speeds up evaluation significantly.</p>
<h2 id="a-full-sotabenchpy-example">A Full sotabench.py Example</h2>
<p>Below we show an implementation for a model from the torchvision repository. This
incorporates all the features explained above: (a) using the server data root, 
(b) using the COCO Evaluator, and (c) caching the evaluation logic. Note that the
torchbench dependency is just to get some processing logic and transforms; the evaluation
is done with sotabencheval.</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tqdm</span> 
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torchbench.utils</span> <span class="kn">import</span> <span class="n">send_model_to_device</span>
<span class="kn">from</span> <span class="nn">torchbench.object_detection.transforms</span> <span class="kn">import</span> <span class="n">Compose</span><span class="p">,</span> <span class="n">ConvertCocoPolysToMask</span><span class="p">,</span> <span class="n">ToTensor</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">PIL</span>

<span class="kn">from</span> <span class="nn">sotabencheval.object_detection</span> <span class="kn">import</span> <span class="n">COCOEvaluator</span>
<span class="kn">from</span> <span class="nn">sotabencheval.utils</span> <span class="kn">import</span> <span class="n">is_server</span>

<span class="k">if</span> <span class="n">is_server</span><span class="p">():</span>
    <span class="n">DATA_ROOT</span> <span class="o">=</span> <span class="s1">&#39;./.data/vision/coco&#39;</span>
<span class="k">else</span><span class="p">:</span> <span class="c1"># local settings</span>
    <span class="n">DATA_ROOT</span> <span class="o">=</span> <span class="s1">&#39;/home/ubuntu/my_data/&#39;</span>

<span class="k">def</span> <span class="nf">coco_data_to_device</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">non_blocking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="n">non_blocking</span><span class="p">)</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="n">non_blocking</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">input</span><span class="p">,</span> <span class="n">target</span>

<span class="k">def</span> <span class="nf">coco_collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">coco_output_transform</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">output</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">target</span>

<span class="n">transforms</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span><span class="n">ConvertCocoPolysToMask</span><span class="p">(),</span> <span class="n">ToTensor</span><span class="p">()])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">detection</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;maskrcnn_resnet50_fpn&#39;</span><span class="p">](</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">91</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">model</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">send_model_to_device</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="n">num_gpu</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">model_output_transform</span> <span class="o">=</span> <span class="n">coco_output_transform</span>
<span class="n">send_data_to_device</span> <span class="o">=</span> <span class="n">coco_data_to_device</span>
<span class="n">collate_fn</span> <span class="o">=</span> <span class="n">coco_collate_fn</span>

<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torchbench</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CocoDetection</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_ROOT</span><span class="p">,</span> <span class="s2">&quot;val</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;2017&#39;</span><span class="p">),</span>
    <span class="n">annFile</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">DATA_ROOT</span><span class="p">,</span> <span class="s2">&quot;annotations/instances_val</span><span class="si">%s</span><span class="s2">.json&quot;</span> <span class="o">%</span> <span class="s1">&#39;2017&#39;</span>
    <span class="p">),</span>
    <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">target_transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">,</span>
    <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">test_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">test_loader</span><span class="o">.</span><span class="n">no_classes</span> <span class="o">=</span> <span class="mi">91</span>  <span class="c1"># Number of classes for COCO Detection</span>

<span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Evaluation&quot;</span><span class="p">,</span> <span class="n">mininterval</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">evaluator</span> <span class="o">=</span> <span class="n">COCOEvaluator</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="n">DATA_ROOT</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;Mask R-CNN (ResNet-50-FPN)&#39;</span><span class="p">,</span>
    <span class="n">paper_arxiv_id</span><span class="o">=</span><span class="s1">&#39;1703.06870&#39;</span>

<span class="k">def</span> <span class="nf">prepare_for_coco_detection</span><span class="p">(</span><span class="n">predictions</span><span class="p">):</span>
    <span class="n">coco_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">original_id</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">boxes</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">convert_to_xywh</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">coco_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;image_id&quot;</span><span class="p">:</span> <span class="n">original_id</span><span class="p">,</span>
                    <span class="s2">&quot;category_id&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                    <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="n">box</span><span class="p">,</span>
                    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">coco_results</span>

<span class="k">def</span> <span class="nf">convert_to_xywh</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
        <span class="nb">input</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">send_data_to_device</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">original_output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">model_output_transform</span><span class="p">(</span><span class="n">original_output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tar</span><span class="p">[</span><span class="s2">&quot;image_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">():</span> <span class="n">out</span> <span class="k">for</span> <span class="n">tar</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">prepare_for_coco_detection</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="n">evaluator</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">cache_exists</span><span class="p">:</span>
            <span class="k">break</span>

<span class="n">evaluator</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<h2 id="need-more-help">Need More Help?</h2>
<p>Head on over to the <a href="https://forum.sotabench.com/c/cv">Computer Vision</a> section of the sotabench
forums if you have any questions or difficulties.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="Welcome to sotabencheval!" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Welcome to sotabencheval!
              </span>
            </div>
          </a>
        
        
          <a href="../imagenet/" title="ImageNet" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                ImageNet
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>